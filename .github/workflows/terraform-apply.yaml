name: Terraform apply

on:
  push:
    branches: 
      - main  # main 브랜치에 푸시 될 때만 실행됨
    paths:
      - 'terraform/**'  # terraform 폴더 내 파일이 변결될 때만 트리거

jobs:
  terraform:
    runs-on: ubuntu-latest  #  GitHub Actions 워크플로우가 실행될 때 사용할 가상 머신 환경으로, GitHub Actions를 사용할 경우 ubuntu-latest를 사용하는 것이 일반적임
    
    steps:
    # 1. GitHub Actions 워크플로우에서 저장소 코드 체크아웃(다운로드)
    - name: Checkout code
      uses: actions/checkout@v3  # GitHub에서 제공하는 공식 액션 : 워크플로우가 실행될 때 저장소의 코드를 가져옴

    # 2. Terraform 설치
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.10.5

    # 3. AWS 인증 설정 (GitHub Secrets 사용) : 이를 이용해 AWS 리소스에 접근
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    # 4. Terraform 초기화
    - name: Terraform Init
      run: terraform init -backend-config="key=terraform/state/terraform.tfstate"
      working-directory: ./terraform

    # 5. Terraform Plan (선택 사항) : 변경사항 미리 확인
    - name: Terraform Plan
      run: terraform plan -out=tfplan
      working-directory: ./terraform

    # 6. Terraform Apply (자동 승인)
    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      working-directory: ./terraform
